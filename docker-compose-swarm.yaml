version: "3.8"

services:
  cortexx:
    image: heltonfraga/cortexx:latest
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=3001
      - WUZAPI_BASE_URL=https://wzapi.wasend.com.br
      - WUZAPI_ADMIN_TOKEN=UeH7cZ2c1K3zVUBFi7SginSC
      - SESSION_SECRET=XD6mESFW5itqQRurV81IQMMnr+bQuAlGs8xzPvr68Ts=
      - CORS_ORIGINS=https://cortexx.online,https://*.cortexx.online
      - WEBHOOK_BASE_URL=https://cortexx.online
      - REQUEST_TIMEOUT=10000
      - TZ=America/Sao_Paulo
      # Supabase Configuration (Database)
      - SUPABASE_URL=https://bdhkfyvyvgfdukdodddr.supabase.co
      - SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaGtmeXZ5dmdmZHVrZG9kZGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MTE2NDYsImV4cCI6MjA4MTM4NzY0Nn0.6ekEVkvP-HADksTzvr5YxXxxXpdDPJJKd4vV98VhBmU
      - SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkaGtmeXZ5dmdmZHVrZG9kZGRyIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTgxMTY0NiwiZXhwIjoyMDgxMzg3NjQ2fQ.Y9-tRBAqj0XNwM-hqnRhFbmAi2skdCBO-bLjPg-nIWo
      # Node.js Optimizations
      - NODE_OPTIONS=--max-old-space-size=1024
      - UV_THREADPOOL_SIZE=4
      # Logging
      - LOG_LEVEL=info
      # S3 Storage Configuration
      - S3_ENABLED=true
      - S3_ENDPOINT=https://s3.wasend.com.br
      - S3_REGION=nyc3
      - S3_BUCKET=typebot
      - S3_ACCESS_KEY_ID=9rn0futJO6Vpc3bJcvE6
      - S3_SECRET_ACCESS_KEY=CH9ASlWy0PsK3ozFQyDessRpcWACC6NcBq5CW9P5
      - S3_FORCE_PATH_STYLE=true
      # S3 Upload Settings
      - S3_UPLOAD_MAX_SIZE=52428800
      - S3_PRESIGNED_URL_EXPIRY=3600
    
    # Deployment configuration
    deploy:
      replicas: 1  # Single instance for session consistency
      placement:
        constraints:
          - node.role == manager  # Run on manager node only
      restart_policy:
        condition: any
        delay: 5s
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      labels:
        - traefik.enable=true
        # Router HTTPS - domínio principal + subdomínios
        - traefik.http.routers.cortexx.rule=Host(`cortexx.online`) || Host(`acmecorp.cortexx.online`) || Host(`cortexx.cortexx.online`) || Host(`superadmin.cortexx.online`)
        - traefik.http.routers.cortexx.entrypoints=websecure
        - traefik.http.routers.cortexx.tls=true
        - traefik.http.routers.cortexx.tls.certresolver=letsencryptresolver
        # Service configuration
        - traefik.http.services.cortexx.loadbalancer.server.port=3001
        - traefik.http.services.cortexx.loadbalancer.healthcheck.path=/health
        - traefik.http.services.cortexx.loadbalancer.healthcheck.interval=30s
        - traefik.http.services.cortexx.loadbalancer.healthcheck.timeout=10s
        - traefik.http.services.cortexx.loadbalancer.sticky.cookie=true
        - traefik.http.services.cortexx.loadbalancer.sticky.cookie.name=cortexx_session
    
    # Ports (optional - Traefik handles routing)
    ports:
      - "3005:3001"
    
    # Volumes - Only logs needed (Supabase handles data)
    volumes:
      - cortexx-logs:/app/logs
    
    # Health check - Updated to use HTTP endpoint
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    
    # Networks
    networks:
      - network_public

networks:
  network_public:
    external: true
    name: network_public

volumes:
  cortexx-logs:
    driver: local
