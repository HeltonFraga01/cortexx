# GitHub Actions Workflow para Deploy Automatizado
# Cortexx - Deploy Pipeline

name: Deploy Cortexx

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  
  pull_request:
    branches:
      - main
      - develop
  
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
          - development
          - staging
          - production
      version:
        description: 'Version to deploy'
        required: false
        default: 'latest'
      auto_rollback:
        description: 'Enable auto rollback on failure'
        required: false
        default: true
        type: boolean

env:
  REGISTRY: docker.io
  IMAGE_NAME: heltonfraga/cortexx
  NODE_VERSION: '20'

jobs:
  # Job para determinar ambiente e configura√ß√µes
  setup:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      version: ${{ steps.env.outputs.version }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}
      auto_rollback: ${{ steps.env.outputs.auto_rollback }}
    
    steps:
      - name: Determine Environment and Version
        id: env
        run: |
          # Determinar ambiente baseado no trigger
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENVIRONMENT="${{ github.event.inputs.environment }}"
            VERSION="${{ github.event.inputs.version }}"
            AUTO_ROLLBACK="${{ github.event.inputs.auto_rollback }}"
            SHOULD_DEPLOY="true"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENVIRONMENT="production"
            VERSION="${GITHUB_SHA:0:7}"
            AUTO_ROLLBACK="true"
            SHOULD_DEPLOY="true"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENVIRONMENT="staging"
            VERSION="${GITHUB_SHA:0:7}"
            AUTO_ROLLBACK="true"
            SHOULD_DEPLOY="true"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            ENVIRONMENT="production"
            VERSION="${GITHUB_REF#refs/tags/}"
            AUTO_ROLLBACK="true"
            SHOULD_DEPLOY="true"
          else
            ENVIRONMENT="development"
            VERSION="pr-${{ github.event.number }}"
            AUTO_ROLLBACK="false"
            SHOULD_DEPLOY="false"
          fi
          
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "should_deploy=$SHOULD_DEPLOY" >> $GITHUB_OUTPUT
          echo "auto_rollback=$AUTO_ROLLBACK" >> $GITHUB_OUTPUT
          
          echo "Environment: $ENVIRONMENT"
          echo "Version: $VERSION"
          echo "Should Deploy: $SHOULD_DEPLOY"
          echo "Auto Rollback: $AUTO_ROLLBACK"

  # Job para testes
  test:
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Frontend Dependencies
        run: npm ci
      
      - name: Install Backend Dependencies
        run: cd server && npm ci
      
      - name: Run Linting
        run: npm run lint
      
      - name: Run Frontend Tests
        run: npm run test:run
      
      - name: Run Backend Tests
        run: cd server && npm test
      
      - name: Generate Test Coverage
        run: npm run test:coverage
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Job para build da imagem Docker
  build:
    runs-on: ubuntu-latest
    needs: [setup, test]
    if: needs.setup.outputs.should_deploy == 'true'
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Extract Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.setup.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      - name: Run Security Scan
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }}
          only-severities: critical,high
          exit-code: true

  # Job para deploy
  deploy:
    runs-on: ubuntu-latest
    needs: [setup, test, build]
    if: needs.setup.outputs.should_deploy == 'true'
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Setup Deploy Environment
        run: |
          # Instalar depend√™ncias necess√°rias
          sudo apt-get update
          sudo apt-get install -y jq curl
          
          # Configurar Docker context para deploy remoto (se necess√°rio)
          # docker context create remote --docker "host=ssh://user@server"
      
      - name: Deploy to ${{ needs.setup.outputs.environment }}
        run: |
          chmod +x ./scripts/deploy.sh
          
          DEPLOY_ARGS="${{ needs.setup.outputs.environment }} ${{ needs.setup.outputs.version }}"
          
          if [[ "${{ needs.setup.outputs.auto_rollback }}" == "true" ]]; then
            DEPLOY_ARGS="$DEPLOY_ARGS --auto-rollback"
          fi
          
          ./scripts/deploy.sh $DEPLOY_ARGS
        env:
          DOCKER_HOST: ${{ secrets.DOCKER_HOST }}
          DOCKER_CERT_PATH: ${{ secrets.DOCKER_CERT_PATH }}
          DOCKER_TLS_VERIFY: ${{ secrets.DOCKER_TLS_VERIFY }}
      
      - name: Run Post-Deploy Checks
        run: |
          chmod +x ./scripts/post-deploy-check.sh
          ./scripts/post-deploy-check.sh ${{ needs.setup.outputs.environment }}
      
      - name: Update Deployment Status
        if: always()
        run: |
          # Atualizar status do deployment
          STATUS="${{ job.status }}"
          ENVIRONMENT="${{ needs.setup.outputs.environment }}"
          VERSION="${{ needs.setup.outputs.version }}"
          
          echo "Deployment Status: $STATUS"
          echo "Environment: $ENVIRONMENT"
          echo "Version: $VERSION"
          
          # Aqui voc√™ pode integrar com sistemas de monitoramento
          # curl -X POST "$MONITORING_WEBHOOK" -d "{\"status\":\"$STATUS\",\"env\":\"$ENVIRONMENT\",\"version\":\"$VERSION\"}"

  # Job para notifica√ß√µes
  notify:
    runs-on: ubuntu-latest
    needs: [setup, deploy]
    if: always() && needs.setup.outputs.should_deploy == 'true'
    
    steps:
      - name: Notify Slack on Success
        if: needs.deploy.result == 'success'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          text: |
            ‚úÖ Deploy realizado com sucesso!
            Environment: ${{ needs.setup.outputs.environment }}
            Version: ${{ needs.setup.outputs.version }}
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Notify Slack on Failure
        if: needs.deploy.result == 'failure'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          text: |
            ‚ùå Deploy falhou!
            Environment: ${{ needs.setup.outputs.environment }}
            Version: ${{ needs.setup.outputs.version }}
            Commit: ${{ github.sha }}
            
            Verifique os logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Create GitHub Release
        if: needs.deploy.result == 'success' && needs.setup.outputs.environment == 'production' && startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          release_name: Release ${{ needs.setup.outputs.version }}
          body: |
            ## Changes in this Release
            
            - Deploy realizado com sucesso em produ√ß√£o
            - Vers√£o: ${{ needs.setup.outputs.version }}
            - Commit: ${{ github.sha }}
            
            ## Docker Image
            
            ```bash
            docker pull ${{ env.IMAGE_NAME }}:${{ needs.setup.outputs.version }}
            ```
            
            ## Deployment
            
            Esta vers√£o foi automaticamente deployada em produ√ß√£o.
          draft: false
          prerelease: false

  # Job para rollback (manual)
  rollback:
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [setup, deploy]
    environment: ${{ needs.setup.outputs.environment }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Execute Rollback
        run: |
          chmod +x ./scripts/rollback.sh
          
          # Obter vers√£o anterior (implementar l√≥gica para determinar)
          PREVIOUS_VERSION="previous"  # Substituir por l√≥gica real
          
          ./scripts/rollback.sh ${{ needs.setup.outputs.environment }} $PREVIOUS_VERSION
        env:
          DOCKER_HOST: ${{ secrets.DOCKER_HOST }}
          DOCKER_CERT_PATH: ${{ secrets.DOCKER_CERT_PATH }}
          DOCKER_TLS_VERIFY: ${{ secrets.DOCKER_TLS_VERIFY }}
      
      - name: Verify Rollback
        run: |
          chmod +x ./scripts/post-deploy-check.sh
          ./scripts/post-deploy-check.sh ${{ needs.setup.outputs.environment }}
      
      - name: Notify Rollback
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "üîÑ Rollback executado",
              "attachments": [{
                "color": "warning",
                "fields": [{
                  "title": "Environment",
                  "value": "${{ needs.setup.outputs.environment }}",
                  "short": true
                }, {
                  "title": "Previous Version",
                  "value": "previous",
                  "short": true
                }]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}